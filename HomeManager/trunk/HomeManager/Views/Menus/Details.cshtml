@model IEnumerable<HomeManager.Models.Recipe>

@{
    ViewBag.Title = "Details";
}

@section Head{
    <link href="@Url.Content("~/Content/fullcalendar.css")" rel="stylesheet" type="text/css" />
    <script src="@Url.Content("~/Scripts/fullcalendar.js")" type="text/javascript"></script>

    <script type="text/javascript">
        $(document).ready(function () {
            $('#calendar').fullCalendar({
                theme: true,
                defaultView: 'basicWeek',
                events: '@Url.Action("GetMeals", "Menus")',
                height: 200,
                eventClick: function (calEvent, jsEvent, view) {
                    $('#recipeDialog').load(
                        '@Url.Action("CalendarDetail", "Recipes")',
                        {
                            recipeId: calEvent.id,
                            unixDate: new Date(calEvent.start).getTime()
                        },
                        function () {
                            $('#recipeDialog').dialog('option', 'title', calEvent.title);
                            $('#recipeDialog').dialog('open');
                        }
                    );
                },
                drop: function (date, allDay) {
                    var eventObject = $.extend({}, $(this).data('eventObject'));

                    eventObject.date = date;

                    $.getJSON(
                        '@Url.Action("AddRecipe", "Menus")',
                        {
                            recipeId: eventObject.id,
                            unixDate: new Date(eventObject.date).getTime()
                        },
                        function (data) {
                            $('#calendar').fullCalendar('refetchEvents');
                        }
                    );
                },
                droppable: true
            });

            $('#recipes li').each(function () {
                var eventObject = {
                    id: $(this).attr('title'),
                    title: $(this).text(),
                    allDay: true
                };

                $(this).data('eventObject', eventObject);

                $(this).draggable({
                    snap: true,
                    revert: true,
                    revertDuration: 0
                });
            });

            $('#recipeDialog').dialog({
                modal: true,
                height: 300,
                width: 500,
                autoOpen: false
            });

            $('#createshoppinglist').button();
            $('#createshoppinglistform').submit(function () {
                var cal = $('#calendar').fullCalendar('getView');

                $('#startTimestamp').val(new Date(cal.start).getTime());
                $('#endTimestamp').val(new Date(cal.end).getTime());
            });
        });
    </script>
}

<h2>Details</h2>

<div id="calendar"></div>

<div id="recipeDialog"></div>

<div>
    @using (Html.BeginForm("CreateFromMenu", "ShoppingLists", FormMethod.Post, new { id = "createshoppinglistform" })) {
        <input type="hidden" name="startTimestamp" id="startTimestamp" />
        <input type="hidden" name="endTimestamp" id="endTimestamp" />
        <input type="submit" value="Add to Grocery List" id="createshoppinglist" />
    }
</div>

<div id="recipes">
@if (Model.Count() > 0)
{
    <ul class="recipelist">
        @foreach (var item in Model)
        {
            <li title="@item.Id">
                @item.Name @item.PrepTime.Add(item.CookTime)
            </li>
        }
    </ul>
}
</div>
